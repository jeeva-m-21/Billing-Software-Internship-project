<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legal Tracker Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <div class="login-container" id="login-container">
  <div class="login-bg"></div>
  <div class="login-card">
    <h1>Legal Tracker</h1>
    <p class="muted">Sign in with Google to access the dashboard</p>
    <button id="authorize_button" class="login-btn">Sign In with Google</button>
  </div>
</div>

<div class="dashboard-wrapper hidden" id="dashboard-wrapper">
    <header>
    <h1>Legal Tracker Dashboard</h1>
    <button id="signout_button" class="signout-btn">Sign Out</button>
  </header>

  <div class="controls">
    <button onclick="toggleView('view-submissions')" class="control-btn">üìù View Submissions</button>
    <button onclick="toggleView('add-record')" class="control-btn">‚ûï Add New Record</button>
  </div>

  <!-- View Submissions -->
  <div id="view-submissions-view" class="content-view">
    <h2>View Submissions</h2>
    <input type="text" id="search-box" placeholder="Search by Project Name, Unique No, Builder Group" oninput="filterRecords()" />
    <div id="submissions-table-container" class="table-container"></div>
    <div id="no-results" class="no-results hidden">No matching records found</div>
  </div>

  <!-- Add Record -->
  <div id="add-record-view" class="content-view hidden">
    <h2>Add New Submission</h2>
    <div class="form-grid">
      <div class="form-group"><label>Project Name:</label><input type="text" id="new-project-name"></div>
      <div class="form-group"><label>Unique No / APF ID:</label><input type="text" id="new-apf-id"></div>
      <div class="form-group full-width"><label>Builder Group & Company:</label><input type="text" id="new-builder-group"></div>
      <div class="form-group"><label>Status:</label><input type="text" id="new-status"></div>
      <div class="form-group full-width"><label>Postal Address:</label><input type="text" id="new-address"></div>
      <div class="form-group"><label>State / City:</label><input type="text" id="new-state-city"></div>
      <div class="form-group full-width"><label>Currently Pending With:</label><input type="text" id="new-pending-with"></div>
      <div class="form-group full-width"><label>Action:</label><input type="text" id="new-action"></div>
    </div>
    <button id="submit_record_button" class="submit-btn">Submit Record</button>
  </div>
</div>

<script>
const CLIENT_ID = '94377658407-cm6ghkgsk5iuoj1sl7bv4lru6vo9ed54.apps.googleusercontent.com';
const SPREADSHEET_ID = '16Ovk2aISc0aood-b78EyoIYeQKR2LK7PyVhuCs6toHs';
const SHEET_RANGE = 'Sheet1';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

let tokenClient;
let gapiInited = false;
let gisInited = false;
let allSubmissions = [];

const loginContainer = document.getElementById('login-container');
const dashboardWrapper = document.getElementById('dashboard-wrapper');
const authorizeButton = document.getElementById('authorize_button');
const signoutButton = document.getElementById('signout_button');
const submitRecordButton = document.getElementById('submit_record_button');

function gapiLoaded() { gapi.load('client', initializeGapiClient); }
function gisLoaded() { gisInited = true; initializeGisClient(); }

function initializeGapiClient() {
  gapi.client.init({
    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
  }).then(() => {
    gapiInited = true;
    updateAuthUI();
  });
}

function initializeGisClient() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      if (resp.access_token) {
        gapi.client.setToken(resp);
        updateAuthUI();
        fetchSubmissions();
      }
    }
  });
  authorizeButton.onclick = handleAuthClick;
  signoutButton.onclick = handleSignoutClick;
  submitRecordButton.onclick = submitNewRecordToSheet;
}

function handleAuthClick() {
  tokenClient.requestAccessToken({prompt: 'consent'});
}

function handleSignoutClick() {
  const token = gapi.client.getToken();
  if(token) {
    google.accounts.oauth2.revoke(token.access_token, () => {
      // Clear client token and update UI
      try { gapi.client.setToken(null); } catch(e) { console.warn('Could not clear token', e); }
      updateAuthUI();
    });
  }
}

function updateAuthUI() {
  if(!gapiInited || !gisInited) return;
  if(!gapi.client.getToken()) {
    loginContainer.classList.remove('hidden');
    dashboardWrapper.classList.add('hidden');
  } else {
    loginContainer.classList.add('hidden');
    dashboardWrapper.classList.remove('hidden');
    toggleView('view-submissions');
  }
}

function toggleView(viewName) {
  document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
  const el = document.getElementById(`${viewName}-view`);
  if(el) el.classList.remove('hidden');
}

async function fetchSubmissions() {
  try {
    const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: SHEET_RANGE });
    const data = response.result.values;
    if (!data || data.length < 2) return;
    const headers = data[0];
    // store headers globally so filtered views can reuse the same column order
    window.sheetHeaders = headers;
    allSubmissions = data.slice(1);
    displaySubmissions(allSubmissions, headers);
  } catch(e) { console.error(e); }
}

function displaySubmissions(records, headers) {
  let html = '<table><thead><tr>';
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  records.forEach(r => { html += '<tr>'; r.forEach(c => html += `<td>${c || '-'}</td>`); html += '</tr>'; });
  html += '</tbody></table>';
  document.getElementById('submissions-table-container').innerHTML = html;
}

function filterRecords() {
  const term = (document.getElementById('search-box').value || '').trim().toLowerCase();
  if (!term) {
    document.getElementById('no-results').classList.add('hidden');
    return displaySubmissions(allSubmissions, window.sheetHeaders || []);
  }
  const filtered = allSubmissions.filter(r => {
    // check all columns for the search term
    return r.some(cell => (cell || '').toString().toLowerCase().includes(term));
  });
  const headers = window.sheetHeaders || ['Project Name','Unique No / APF ID','Builder Group & Company','Status','Postal Address','State / City','Currently Pending With','Action'];
  displaySubmissions(filtered, headers);
  const noResultsEl = document.getElementById('no-results');
  if (filtered.length === 0) noResultsEl.classList.remove('hidden'); else noResultsEl.classList.add('hidden');
}

async function submitNewRecordToSheet() {
  const values = [
    document.getElementById('new-project-name').value || '-',
    document.getElementById('new-apf-id').value || '-',
    document.getElementById('new-builder-group').value || '-',
    document.getElementById('new-status').value || '-',
    document.getElementById('new-address').value || '-',
    document.getElementById('new-state-city').value || '-',
    document.getElementById('new-pending-with').value || '-',
    document.getElementById('new-action').value || '-'
  ];
  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: SHEET_RANGE,
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: { values: [values] }
    });
    alert('Record added!');
    fetchSubmissions();
    document.querySelectorAll('#add-record-view input').forEach(i => i.value = '');
  } catch(e) { console.error(e); alert('Failed to add record'); }
}
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
